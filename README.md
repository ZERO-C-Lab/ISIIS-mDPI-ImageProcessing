# ISIIS-mDPI-ImageProcessing
 Flat-fielding and segmenting images from the ISIIS, mDPI compact vehicle, and benchtop mDPI

These macros run in ImageJ and complete the process of flat fielding and segmentation on various iterations of shadowgraph imaging (the ISIIS, benchtop mDPI, and compact vehicle mDPI). Before running these macros in ImageJ, be sure to have your ImageJ enviornment set up correctly. First, you will need to install the Image Calculator Plus macro by following the instructions here https://imagej.net/ij/plugins/calculator-plus.html . Then you should download the StackAverage_.txt file (included in the repository) and compile it in ImageJ. Before compiling, open the .txt file in notepad and save as "All Files" and type in ".java" at the end of the file name. This will save StackAverage as a .java file, which essentially tags it as Java code. Once the .txt is converted into a .java file, it can be compiled in ImageJ by opening ImageJ and selecting Plugins -> Compile and Run. Then choose the .java file with the code for StackAverage (should be StackAverage_.java - don't forget the underscore that is needed in all plugins!). If successful, a StackAverage_.class file will be created, and you will be able to see the plugin name in the "Plugins" drop down menu. Once Image Calculator Plus and StackAverage_.class are installed, you can run flat-fielding on images from these different devices. All macros require setting up directories on your machine for the output files or, in some cases, image statistics. Take note of when those directories are required, and edit the code to match them on your machine. Once you have the directories set up to match the macro you want to use, in ImageJ select Plugins -> Macros -> Run, and then watch the fun begin!

The flat-fielding code runs on .avi files, .tiff stacks, or individual .tiffs. All of these codes will generate an average background and use that to divide it out, resulting in smooth lighting and blemish free images that are ready for segmentation. If you have individual .tiff files that you want to process, you will want to use the macros that begin with "mDPI." Our modular Deep-focus Plankton Imager generates individual tiffs. The large ISIIS and the benchtop mDPI typically generate .tiff stacks or .avi files. For either of these, you can use the StackFlatFielder macros to generate flat fielded images. The results of this process then go into the ParticleCountSegmenter macros, which work on .tiff stacks.

Segmentation is the process of removing Regions of Interest (ROIs) within a certain size range (in pixels) as specified by the user. The default code includes empty space in the middle of a object (as commonly seen in gelatinous zooplankton) as part of the calculate size. These ROIs are saved to their own directory and can be identified manually or automatically. An example StartupMacros.txt file is provided to demonstrate how you can use ImageJ to set up keyboard shortcuts to identify ROIs in a directory. There is also a keyboard shortcut (0) to experiment with flat fielding a .tiff image stack. 

Macros for the mDPI were written by Patrick Duffy and include the full processing pipeline (flat-fielding and segmention) or itemized versions to run these processes separately.
